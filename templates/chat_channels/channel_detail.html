{% extends 'base.html' %}

{% block title %}#{{ channel.name }} - ConnectFlow Pro{% endblock %}

{% load static %}

{% block extra_js %}
<script src="{% static 'js/emojis.js' %}" charset="UTF-8"></script>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Channel Header -->
    <div class="bg-white shadow-lg rounded-lg p-8 mb-8">
        <div class="flex items-start justify-between">
            <div class="flex-1">
                <div class="flex items-center space-x-3 mb-2">
                    <h1 class="text-4xl font-bold text-gray-800">#{{ channel.name }}</h1>
                    <span class="bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full text-sm">
                        {{ channel.get_channel_type_display }}
                    </span>
                    {% if channel.is_private %}
                        <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm">üîí Private</span>
                    {% endif %}
                    {% if channel.read_only %}
                        <span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-sm">Read-only</span>
                    {% endif %}
                </div>
                
                {% if channel.description %}
                    <p class="text-gray-600 mb-4">{{ channel.description }}</p>
                {% endif %}
                
                <div class="flex items-center space-x-6 text-sm text-gray-600">
                    <span>üë• {{ channel.member_count }} member{{ channel.member_count|pluralize }}</span>
                    <span>üìÖ Created {{ channel.created_at|date:"M d, Y" }}</span>
                    {% if channel.created_by %}
                        <span>üë§ by {{ channel.created_by.get_full_name }}</span>
                    {% endif %}
                </div>
            </div>
            
            {% if can_edit %}
                <div class="flex space-x-2">
                    <a href="{% url 'chat_channels:channel_edit' channel.pk %}" 
                       class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-4 py-2 rounded-lg transition">
                        Edit
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Channel Info -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <!-- Details Card -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Channel Details</h2>
            <div class="space-y-3">
                <div>
                    <p class="text-sm text-gray-600">Type</p>
                    <p class="font-medium text-gray-800">{{ channel.get_channel_type_display }}</p>
                </div>
                {% if channel.department %}
                    <div>
                        <p class="text-sm text-gray-600">Department</p>
                        <p class="font-medium text-gray-800">{{ channel.department.name }}</p>
                    </div>
                {% endif %}
                {% if channel.team %}
                    <div>
                        <p class="text-sm text-gray-600">Team</p>
                        <p class="font-medium text-gray-800">{{ channel.team.name }}</p>
                    </div>
                {% endif %}
                <div>
                    <p class="text-sm text-gray-600">Organization</p>
                    <p class="font-medium text-gray-800">{{ channel.organization.name }}</p>
                </div>
            </div>
        </div>

        <!-- Members Card -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Members ({{ channel.member_count }})</h2>
            <div class="space-y-2 max-h-64 overflow-y-auto">
                {% for member in channel.members.all %}
                    <div class="flex items-center space-x-3 p-2 hover:bg-gray-50 rounded">
                        <div class="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center text-white font-bold">
                            {{ member.first_name.0|default:member.username.0|upper }}
                        </div>
                        <div>
                            <p class="font-medium text-gray-800">{{ member.get_full_name }}</p>
                            <p class="text-xs text-gray-500">{{ member.get_role_display }}</p>
                        </div>
                    </div>
                {% empty %}
                    <p class="text-gray-500">No members yet.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Messages Section -->
    <div class="bg-white shadow-lg rounded-lg overflow-hidden mb-8">
        <div class="bg-gray-50 border-b border-gray-200 px-6 py-4">
            <h2 class="text-xl font-bold text-gray-800">üí¨ Messages</h2>
        </div>

        <!-- Messages List -->
        <div class="p-6 max-h-[500px] overflow-y-auto space-y-4" id="messages-container">
            {% for message in messages %}
                <div class="flex space-x-3 {% if message.sender == user %}flex-row-reverse space-x-reverse{% endif %}">
                    <!-- Avatar -->
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center text-white font-bold">
                            {{ message.sender.first_name.0|default:message.sender.username.0|upper }}
                        </div>
                    </div>

                    <!-- Message Content -->
                    <div class="flex-1 max-w-2xl">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="font-semibold text-gray-800">{{ message.sender.get_full_name }}</span>
                            <span class="text-xs text-gray-500">{{ message.created_at|date:"M d, h:i A" }}</span>
                            {% if message.is_edited %}
                                <span class="text-xs text-gray-400">(edited)</span>
                            {% endif %}
                        </div>

                        <div class="{% if message.sender == user %}bg-indigo-500 text-white{% else %}bg-gray-100 text-gray-800{% endif %} rounded-lg px-4 py-3">
                            {% if message.voice_message %}
                                <!-- Voice Message -->
                                <div class="flex items-center space-x-3">
                                    <button type="button" 
                                            onclick="playVoiceMessage('{{ message.pk }}')"
                                            class="{% if message.sender == user %}text-white hover:text-indigo-100{% else %}text-indigo-600 hover:text-indigo-700{% endif %} transition">
                                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M8 5v14l11-7z"/>
                                        </svg>
                                    </button>
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                            </svg>
                                            <span class="text-sm">Voice message</span>
                                            {% if message.voice_duration %}
                                                <span class="text-xs {% if message.sender == user %}text-indigo-100{% else %}text-gray-500{% endif %}">
                                                    {{ message.voice_duration }}s
                                                </span>
                                            {% endif %}
                                        </div>
                                        <div class="w-full bg-{% if message.sender == user %}indigo-400{% else %}gray-300{% endif %} h-1 rounded-full mt-2">
                                            <div class="bg-{% if message.sender == user %}white{% else %}indigo-600{% endif %} h-1 rounded-full" style="width: 0%" id="voice-progress-{{ message.pk }}"></div>
                                        </div>
                                    </div>
                                    <audio id="voice-audio-{{ message.pk }}" src="{{ message.voice_message.url }}" class="hidden"></audio>
                                </div>
                            {% else %}
                                <p class="whitespace-pre-wrap break-words">{{ message.content }}</p>
                            {% endif %}
                            
                            {% if message.file %}
                                <div class="mt-2 pt-2 border-t {% if message.sender == user %}border-indigo-400{% else %}border-gray-200{% endif %}">
                                    {% if message.file.name|lower|slice:"-4:" in ".jpg.png.gif.bmp" or message.file.name|lower|slice:"-5:" in ".jpeg.webp" %}
                                        <!-- Image Preview -->
                                        <a href="{{ message.file.url }}" target="_blank" class="block">
                                            <img src="{{ message.file.url }}" 
                                                 alt="{{ message.file.name }}" 
                                                 class="max-w-xs max-h-64 rounded-lg cursor-pointer hover:opacity-90 transition"
                                                 loading="lazy">
                                        </a>
                                        <p class="text-xs mt-1 {% if message.sender == user %}text-indigo-100{% else %}text-gray-500{% endif %}">
                                            {{ message.file.name }}
                                        </p>
                                    {% else %}
                                        <!-- File Download Link -->
                                        <a href="{{ message.file.url }}" target="_blank" 
                                           class="flex items-center space-x-2 {% if message.sender == user %}text-indigo-100 hover:text-white{% else %}text-indigo-600 hover:text-indigo-700{% endif %}">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                            <span class="text-sm">{{ message.file.name }}</span>
                                        </a>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Reactions -->
                        {% if message.reaction_summary %}
                            <div class="flex flex-wrap gap-1 mt-2">
                                {% for emoji, count in message.reaction_summary.items %}
                                    <span class="inline-flex items-center bg-gray-100 px-2 py-1 rounded-full text-sm">
                                        <span>{{ emoji }}</span>
                                        <span class="ml-1 text-xs text-gray-600">{{ count }}</span>
                                    </span>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- Message Actions -->
                        <div class="flex items-center space-x-3 mt-2">
                            <!-- React with Emoji Picker -->
                            <div class="relative inline-block">
                                <button type="button" 
                                        onclick="toggleEmojiPicker('{{ message.pk }}')"
                                        class="text-xs text-gray-500 hover:text-indigo-600 transition">
                                    Add Reaction üòä
                                </button>
                                
                                <!-- Emoji Picker Dropdown -->
                                <div id="emoji-picker-{{ message.pk }}" 
                                     class="hidden absolute bottom-full left-0 mb-2 bg-white rounded-xl shadow-2xl z-50 overflow-hidden border-2 border-gray-100"
                                     style="width: 350px;">
                                    
                                    <!-- Emoji Categories -->
                                    <div class="border-b border-gray-100 px-2 py-2 bg-gradient-to-r from-indigo-50 to-purple-50">
                                        <div class="flex justify-between items-center text-2xl">
                                            <button type="button" onclick="showEmojiCategory('{{ message.pk }}', 'recent')" class="hover:bg-white hover:scale-110 p-2 rounded-lg transition-all" title="Recent">üïê</button>
                                            <button type="button" onclick="showEmojiCategory('{{ message.pk }}', 'smileys')" class="hover:bg-white hover:scale-110 p-2 rounded-lg transition-all" title="Smileys">üòä</button>
                                            <button type="button" onclick="showEmojiCategory('{{ message.pk }}', 'people')" class="hover:bg-white hover:scale-110 p-2 rounded-lg transition-all" title="People">üëã</button>
                                            <button type="button" onclick="showEmojiCategory('{{ message.pk }}', 'nature')" class="hover:bg-white hover:scale-110 p-2 rounded-lg transition-all" title="Nature">üå∫</button>
                                            <button type="button" onclick="showEmojiCategory('{{ message.pk }}', 'food')" class="hover:bg-white hover:scale-110 p-2 rounded-lg transition-all" title="Food">üçï</button>
                                            <button type="button" onclick="showEmojiCategory('{{ message.pk }}', 'activities')" class="hover:bg-white hover:scale-110 p-2 rounded-lg transition-all" title="Activities">‚öΩ</button>
                                            <button type="button" onclick="showEmojiCategory('{{ message.pk }}', 'travel')" class="hover:bg-white hover:scale-110 p-2 rounded-lg transition-all" title="Travel">‚úàÔ∏è</button>
                                            <button type="button" onclick="showEmojiCategory('{{ message.pk }}', 'objects')" class="hover:bg-white hover:scale-110 p-2 rounded-lg transition-all" title="Objects">üí°</button>
                                        </div>
                                    </div>
                                    
                                    <!-- Emoji Grid -->
                                    <div class="overflow-y-auto overflow-x-hidden p-3 bg-white" style="max-height: 300px; scrollbar-width: thin; scrollbar-color: #cbd5e1 #f1f5f9;" id="emoji-grid-{{ message.pk }}">
                                        <!-- Emojis loaded via JavaScript -->
                                    </div>
                                    
                                    <!-- Hidden form for submission -->
                                    <form id="reaction-form-{{ message.pk }}" method="post" action="{% url 'chat_channels:message_react' message.pk %}" class="hidden">
                                        {% csrf_token %}
                                        <input type="hidden" name="emoji" id="emoji-input-{{ message.pk }}">
                                    </form>
                                </div>
                            </div>

                            <!-- Delete (only for sender or admin) -->
                            {% if message.sender == user or user.is_admin %}
                                <form method="post" action="{% url 'chat_channels:message_delete' message.pk %}" class="inline"
                                      onsubmit="return confirm('Delete this message?')">
                                    {% csrf_token %}
                                    <button type="submit" class="text-xs text-red-500 hover:text-red-700 transition">
                                        Delete
                                    </button>
                                </form>
                            {% endif %}

                            <!-- Reply count -->
                            {% if message.reply_count > 0 %}
                                <span class="text-xs text-gray-500">{{ message.reply_count }} repl{{ message.reply_count|pluralize:"y,ies" }}</span>
                            {% endif %}
                        </div>

                        <!-- Replies -->
                        {% if message.replies.all %}
                            <div class="ml-6 mt-3 space-y-3 border-l-2 border-gray-200 pl-4">
                                {% for reply in message.replies.all %}
                                    {% if not reply.is_deleted %}
                                        <div class="text-sm">
                                            <div class="flex items-center space-x-2 mb-1">
                                                <span class="font-semibold text-gray-700">{{ reply.sender.get_full_name }}</span>
                                                <span class="text-xs text-gray-400">{{ reply.created_at|date:"M d, h:i A" }}</span>
                                            </div>
                                            <div class="bg-gray-50 rounded px-3 py-2">
                                                <p class="text-gray-700">{{ reply.content }}</p>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% empty %}
                <div class="text-center py-12">
                    <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    <p class="text-gray-500">No messages yet. Start the conversation!</p>
                </div>
            {% endfor %}
        </div>

        <!-- Message Input -->
        {% if can_post %}
            <div class="border-t border-gray-200 p-4 bg-gray-50">
                <form method="post" enctype="multipart/form-data" class="space-y-3">
                    {% csrf_token %}
                    
                    {{ form.parent_message }}
                    {{ form.voice_message }}
                    {{ form.voice_duration }}
                    
                    <div>
                        {{ form.content }}
                        {% if form.content.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ form.content.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Voice Recording Preview -->
                    <div id="voice-preview" class="hidden mb-3 p-4 bg-red-50 border border-red-200 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="flex items-center space-x-2">
                                    <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                                    <span class="text-sm font-medium text-red-700">Recording...</span>
                                    <span id="recording-time" class="text-sm text-red-600">0:00</span>
                                </div>
                            </div>
                            <button type="button" onclick="stopVoiceRecording()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-1 rounded transition">
                                Stop
                            </button>
                        </div>
                    </div>

                    <!-- Voice Playback Preview -->
                    <div id="voice-playback" class="hidden mb-3 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3 flex-1">
                                <button type="button" onclick="playVoicePreview()" class="text-indigo-600 hover:text-indigo-700">
                                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                </button>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-indigo-700">Voice message recorded</p>
                                    <p id="playback-duration" class="text-xs text-indigo-600">Duration: 0:00</p>
                                </div>
                            </div>
                            <button type="button" onclick="clearVoiceRecording()" class="text-red-500 hover:text-red-700">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <audio id="voice-preview-audio" class="hidden"></audio>
                    </div>

                    <!-- File Preview -->
                    <div id="file-preview" class="hidden mb-3 p-3 bg-white border border-gray-200 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <img id="preview-image" class="hidden h-20 w-20 object-cover rounded" alt="Preview">
                                <div id="preview-info">
                                    <p id="preview-name" class="text-sm font-medium text-gray-700"></p>
                                    <p id="preview-size" class="text-xs text-gray-500"></p>
                                </div>
                            </div>
                            <button type="button" onclick="clearFilePreview()" class="text-red-500 hover:text-red-700">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <!-- File Upload -->
                            <label for="file-upload" class="cursor-pointer text-gray-600 hover:text-indigo-600 transition" title="Attach file">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                                </svg>
                            </label>
                            {{ form.file }}
                            
                            <!-- Voice Recording -->
                            <button type="button" 
                                    id="voice-record-btn"
                                    onclick="toggleVoiceRecording()"
                                    class="text-gray-600 hover:text-indigo-600 transition"
                                    title="Record voice message">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                </svg>
                            </button>
                            
                            <!-- Emoji Picker for Message Input -->
                            <div class="relative inline-block">
                                <button type="button" 
                                        onclick="toggleMessageEmojiPicker()"
                                        class="text-gray-600 hover:text-indigo-600 transition"
                                        title="Add emoji">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </button>
                                
                                <!-- Emoji Picker for Message -->
                                <div id="message-emoji-picker" 
                                     class="hidden absolute bottom-full left-0 mb-2 bg-white border border-gray-200 rounded-lg shadow-xl z-50 overflow-hidden"
                                     style="width: 420px; max-height: 450px;">
                                    
                                    <!-- Emoji Categories -->
                                    <div class="border-b border-gray-200 px-3 py-2 bg-gray-50">
                                        <div class="flex space-x-1 text-lg overflow-x-auto" style="scrollbar-width: none; -ms-overflow-style: none;">
                                            <button type="button" onclick="showMessageEmojiCategory('recent')" class="hover:bg-gray-200 p-1.5 rounded flex-shrink-0" title="Recent">üïê</button>
                                            <button type="button" onclick="showMessageEmojiCategory('smileys')" class="hover:bg-gray-200 p-1.5 rounded flex-shrink-0" title="Smileys">üòä</button>
                                            <button type="button" onclick="showMessageEmojiCategory('people')" class="hover:bg-gray-200 p-1.5 rounded flex-shrink-0" title="People">üëã</button>
                                            <button type="button" onclick="showMessageEmojiCategory('nature')" class="hover:bg-gray-200 p-1.5 rounded flex-shrink-0" title="Nature">üå∫</button>
                                            <button type="button" onclick="showMessageEmojiCategory('food')" class="hover:bg-gray-200 p-1.5 rounded flex-shrink-0" title="Food">üçï</button>
                                            <button type="button" onclick="showMessageEmojiCategory('activities')" class="hover:bg-gray-200 p-1.5 rounded flex-shrink-0" title="Activities">‚öΩ</button>
                                            <button type="button" onclick="showMessageEmojiCategory('travel')" class="hover:bg-gray-200 p-1.5 rounded flex-shrink-0" title="Travel">‚úàÔ∏è</button>
                                            <button type="button" onclick="showMessageEmojiCategory('objects')" class="hover:bg-gray-200 p-1.5 rounded flex-shrink-0" title="Objects">üí°</button>
                                            <button type="button" onclick="showMessageEmojiCategory('symbols')" class="hover:bg-gray-200 p-1.5 rounded flex-shrink-0" title="Symbols">‚ù§Ô∏è</button>
                                        </div>
                                    </div>
                                    
                                    <!-- Emoji Grid -->
                                    <div class="overflow-y-auto overflow-x-hidden p-3" style="max-height: 380px;" id="message-emoji-grid">
                                        <!-- Emojis loaded via JavaScript -->
                                    </div>
                                </div>
                            </div>
                            
                            <span class="text-xs text-gray-500">Press Shift+Enter for new line</span>
                        </div>

                        <button type="submit" 
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg transition flex items-center space-x-2">
                            <span>Send</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </div>
                </form>
            </div>
        {% else %}
            <div class="border-t border-gray-200 p-4 bg-gray-50 text-center">
                <p class="text-gray-500 text-sm">
                    {% if channel.read_only %}
                        üîí This is a read-only channel. Only admins can post.
                    {% else %}
                        You need to be a member to post messages.
                    {% endif %}
                </p>
            </div>
        {% endif %}
    </div>

    <!-- Back Button -->
    <div class="mt-8">
        <a href="{% url 'chat_channels:channel_list' %}" 
           class="text-indigo-600 hover:text-indigo-700 font-semibold">
            ‚Üê Back to Channels
        </a>
    </div>
</div>

<script>
// Recently used emojis (from localStorage)
let recentEmojis = JSON.parse(localStorage.getItem('recentEmojis') || '["üëç", "‚ù§Ô∏è", "üòä", "üòÇ", "üéâ", "üî•", "üëè", "‚úÖ"]');

// Add to recent
function addToRecent(emoji) {
    recentEmojis = recentEmojis.filter(e => e !== emoji);
    recentEmojis.unshift(emoji);
    recentEmojis = recentEmojis.slice(0, 24);
    localStorage.setItem('recentEmojis', JSON.stringify(recentEmojis));
    emojis.recent = recentEmojis;
}

// Show emoji category for reactions
function showEmojiCategory(messageId, category) {
    const grid = document.getElementById('emoji-grid-' + messageId);
    const categoryEmojis = emojis[category] || emojis.smileys;
    
    // Clear the grid first
    grid.innerHTML = '';
    
    // Create container
    const container = document.createElement('div');
    container.className = 'grid grid-cols-8 gap-1.5 w-full';
    
    categoryEmojis.forEach(emoji => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'text-3xl hover:bg-indigo-50 hover:scale-125 rounded-lg p-1.5 transition-all duration-150 flex items-center justify-center';
        button.style.minWidth = '42px';
        button.style.minHeight = '42px';
        button.textContent = emoji;
        button.onclick = function() {
            reactWithEmoji(messageId, emoji);
        };
        container.appendChild(button);
    });
    
    grid.appendChild(container);
}

// Show emoji category for message input
function showMessageEmojiCategory(category) {
    const grid = document.getElementById('message-emoji-grid');
    const categoryEmojis = emojis[category] || emojis.smileys;
    
    // Clear the grid first
    grid.innerHTML = '';
    
    // Create container
    const container = document.createElement('div');
    container.className = 'grid grid-cols-10 gap-1 w-full';
    
    categoryEmojis.forEach(emoji => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'text-2xl hover:bg-gray-100 rounded p-2 transition flex items-center justify-center';
        button.style.minWidth = '38px';
        button.style.minHeight = '38px';
        button.textContent = emoji;
        button.onclick = function() {
            insertEmoji(emoji);
        };
        container.appendChild(button);
    });
    
    grid.appendChild(container);
}

// Toggle emoji picker for reactions
function toggleEmojiPicker(messageId) {
    const picker = document.getElementById('emoji-picker-' + messageId);
    const messagePicker = document.getElementById('message-emoji-picker');
    
    // Close message emoji picker
    if (messagePicker) {
        messagePicker.classList.add('hidden');
    }
    
    // Close all other reaction pickers
    document.querySelectorAll('[id^="emoji-picker-"]').forEach(p => {
        if (p.id !== 'emoji-picker-' + messageId) {
            p.classList.add('hidden');
        }
    });
    
    // Toggle this picker
    const wasHidden = picker.classList.contains('hidden');
    picker.classList.toggle('hidden');
    
    // Load smileys by default
    if (wasHidden) {
        showEmojiCategory(messageId, 'smileys');
    }
}

// Toggle emoji picker for message input
function toggleMessageEmojiPicker() {
    const picker = document.getElementById('message-emoji-picker');
    
    // Close all reaction pickers
    document.querySelectorAll('[id^="emoji-picker-"]').forEach(p => {
        p.classList.add('hidden');
    });
    
    // Toggle message picker
    const wasHidden = picker.classList.contains('hidden');
    picker.classList.toggle('hidden');
    
    // Load smileys by default
    if (wasHidden) {
        showMessageEmojiCategory('smileys');
    }
}

// React with emoji
function reactWithEmoji(messageId, emoji) {
    addToRecent(emoji);
    const input = document.getElementById('emoji-input-' + messageId);
    const form = document.getElementById('reaction-form-' + messageId);
    
    input.value = emoji;
    form.submit();
}

// Insert emoji into message textarea
function insertEmoji(emoji) {
    addToRecent(emoji);
    const textarea = document.getElementById('id_content');
    const cursorPos = textarea.selectionStart;
    const textBefore = textarea.value.substring(0, cursorPos);
    const textAfter = textarea.value.substring(cursorPos);
    
    textarea.value = textBefore + emoji + textAfter;
    textarea.focus();
    textarea.selectionStart = textarea.selectionEnd = cursorPos + emoji.length;
    
    // Close the picker
    document.getElementById('message-emoji-picker').classList.add('hidden');
}

// Close emoji pickers when clicking outside
document.addEventListener('click', function(event) {
    const isClickInside = event.target.closest('[id^="emoji-picker-"]') || 
                          event.target.closest('#message-emoji-picker') ||
                          event.target.matches('[onclick*="toggleEmojiPicker"]') ||
                          event.target.matches('[onclick*="toggleMessageEmojiPicker"]') ||
                          event.target.closest('[onclick*="toggleEmojiPicker"]') ||
                          event.target.closest('[onclick*="toggleMessageEmojiPicker"]');
    
    if (!isClickInside) {
        document.querySelectorAll('[id^="emoji-picker-"]').forEach(picker => {
            picker.classList.add('hidden');
        });
        const messagePicker = document.getElementById('message-emoji-picker');
        if (messagePicker) {
            messagePicker.classList.add('hidden');
        }
    }
});

// File upload preview
const fileInput = document.getElementById('file-upload');
if (fileInput) {
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            showFilePreview(file);
        }
    });
}

function showFilePreview(file) {
    const preview = document.getElementById('file-preview');
    const previewImage = document.getElementById('preview-image');
    const previewName = document.getElementById('preview-name');
    const previewSize = document.getElementById('preview-size');
    
    // Show preview container
    preview.classList.remove('hidden');
    
    // Set file name and size
    previewName.textContent = file.name;
    previewSize.textContent = formatFileSize(file.size);
    
    // If it's an image, show thumbnail
    if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImage.src = e.target.result;
            previewImage.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    } else {
        previewImage.classList.add('hidden');
    }
}

function clearFilePreview() {
    const preview = document.getElementById('file-preview');
    const previewImage = document.getElementById('preview-image');
    const fileInput = document.getElementById('file-upload');
    
    // Hide preview
    preview.classList.add('hidden');
    previewImage.src = '';
    previewImage.classList.add('hidden');
    
    // Clear file input
    fileInput.value = '';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Auto-scroll to bottom of messages
window.addEventListener('load', function() {
    const messagesContainer = document.getElementById('messages-container');
    if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
});

// Voice Recording functionality
let mediaRecorder;
let audioChunks = [];
let recordingStartTime;
let recordingTimer;
let recordedBlob;

async function toggleVoiceRecording() {
    const voiceBtn = document.getElementById('voice-record-btn');
    const voicePreview = document.getElementById('voice-preview');
    
    if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = () => {
                recordedBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const audioUrl = URL.createObjectURL(recordedBlob);
                
                // Show playback preview
                const voicePlayback = document.getElementById('voice-playback');
                const voiceAudio = document.getElementById('voice-preview-audio');
                voiceAudio.src = audioUrl;
                
                voicePreview.classList.add('hidden');
                voicePlayback.classList.remove('hidden');
                
                // Calculate duration
                const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
                document.getElementById('playback-duration').textContent = `Duration: ${formatTime(duration)}`;
                document.getElementById('voice-duration-input').value = duration;
                
                // Convert blob to file and set it in the form
                const file = new File([recordedBlob], `voice-${Date.now()}.webm`, { type: 'audio/webm' });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                
                // Create a hidden file input for voice
                const voiceInput = document.getElementById('voice-message-input');
                if (voiceInput) {
                    // We'll handle this in the form submission
                    voiceInput.dataset.voiceBlob = audioUrl;
                }
                
                // Stop all tracks
                stream.getTracks().forEach(track => track.stop());
            };
            
            mediaRecorder.start();
            recordingStartTime = Date.now();
            
            // Show recording preview
            voicePreview.classList.remove('hidden');
            voiceBtn.classList.add('text-red-500');
            
            // Start timer
            recordingTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                document.getElementById('recording-time').textContent = formatTime(elapsed);
            }, 1000);
            
        } catch (err) {
            console.error('Error accessing microphone:', err);
            alert('Unable to access microphone. Please grant permission and try again.');
        }
    }
}

function stopVoiceRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        clearInterval(recordingTimer);
        document.getElementById('voice-record-btn').classList.remove('text-red-500');
    }
}

function clearVoiceRecording() {
    const voicePlayback = document.getElementById('voice-playback');
    const voiceAudio = document.getElementById('voice-preview-audio');
    
    voicePlayback.classList.add('hidden');
    voiceAudio.src = '';
    recordedBlob = null;
    
    document.getElementById('voice-message-input').value = '';
    document.getElementById('voice-duration-input').value = '';
}

function playVoicePreview() {
    const voiceAudio = document.getElementById('voice-preview-audio');
    if (voiceAudio.paused) {
        voiceAudio.play();
    } else {
        voiceAudio.pause();
        voiceAudio.currentTime = 0;
    }
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// Play voice message in chat
function playVoiceMessage(messageId) {
    const audio = document.getElementById('voice-audio-' + messageId);
    const progress = document.getElementById('voice-progress-' + messageId);
    
    if (audio.paused) {
        audio.play();
        
        audio.ontimeupdate = function() {
            const percentage = (audio.currentTime / audio.duration) * 100;
            progress.style.width = percentage + '%';
        };
        
        audio.onended = function() {
            progress.style.width = '0%';
        };
    } else {
        audio.pause();
        audio.currentTime = 0;
    }
}

// Handle form submission with voice message
document.querySelector('form[enctype="multipart/form-data"]').addEventListener('submit', async function(e) {
    if (recordedBlob) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        // Add voice message file
        const voiceFile = new File([recordedBlob], `voice-${Date.now()}.webm`, { type: 'audio/webm' });
        formData.set('voice_message', voiceFile);
        
        // Submit via fetch
        try {
            const response = await fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Error sending voice message');
            }
        } catch (err) {
            console.error('Error:', err);
            alert('Error sending voice message');
        }
    }
});
</script>

{% endblock %}
